---
title: "Volume de Passageiros na Covid-19"
author: "Pedro Lóes - Introdução a Grafos Aleatórios - DEST - UFMG"
date: "23/01/2021"
output:
  html_document:
    code_folding: hide
    toc: true
    number_sections: true
runtime: shiny
---

<style>
body {
text-align: justify}
</style>

***

<center>
![](avioes_parados.jpg){width=800px}
</center>

***

# Tráfego Aéreo das Companhias Brasileiras em 2020

## Abstrato

* _O ano de 2020 foi marcado principalmente pela pandemia do Covid-19 que atingiu proporções globais. Para o setor de aviação e tráfego aéreo brasileiro não foi diferente. O medo da contaminação dentro das aeronaves, o fechamento de fronteiras e a suspensão por parte dos governos de grande parte das operações das companhias aéreas são alguns dos fatores que contribuíram para a diminuição na demanda de transporte aéreo. Os modelos de precificação das companhias aéreas não estavam preparados para o evento Covid-19, porque não possuíam dados históricos para acomodar a variável corona vírus. A queda na demanda provocou a queda no preço das passagens com trechos em que os preços atingiram os incríveis 6 dólares entre New Jersey e Florida. Como o número de passageiros é uma variável de contagem ao longo do tempo, um modelo linear generalizado com a distribuição de Poisson parece adequado para acomodar a flutuação da demanda em futuras pandemias. O objetivo da construção deste modelo foi orientar as companhias aéreas brasileiras na tomada de decisão sobre a suspensão ou funcionamento de rotas e aeronaves baseado no custo-benefício da operação frente a uma nova pandemia global. A demanda de número de passageiros foi ajustada em função do número de mortes e casos acumulados, bem como o número de novos casos e novos casos acumulados com intuito de que essas variáveis pudessem ajudar a explicar a diminuição de passageiros e assim servir como ferramenta para futuros ajustes na operação._

## Introdução

* O presente trabalho foi desenvolvido com o objetivo de aplicar as técnicas ensinadas no curso _"Introdução aos Grafos Aleatórios"_ do Departamento de Estatística da UFMG. O tema escolhido para o trabalho foi “Volume de passageiros na covid 19” e o modelo escolhido foi o modelo de gravidade do capítulo 9 _"Fluxo de Redes"_  do livro  _"Statistical Analysis of Network Data"_.

* A modelagem do problema foi implementada no ambiente de prototipagem R utilizando diversos pacotes (ver referências).

* Dados relevantes para o problema foram coletados de sítios da rede mundial de computadores e foram limpos e processados para serem utilizados na análise descritiva e modelagem. A etapa da análise descritiva foi elaborada usando técnicas de visualização das variáveis explicativas e a resposta. Algumas estatísticas do universo de grafos foram utilizadas para descrever a rede de relação entre os países. A modelagem foi realizada utilizando modelos lineares generalizados considerando a distribuição Poisson com ligação logarítmica. Finalmente as conclusões indicaram que de fato as variáveis escolhidas foram estatisticamente significativas para a modelagem do número de passageiros. 
  
```{r warning=F, error=F, message=F}

# Carrega Bibliotecas
library(tidyverse)
library(igraph)
library(lubridate)
library(DT)
library(naniar)
library(shiny)
library(broom)
library(geosphere)
library(gridExtra)
library(shinyWidgets)
library(visNetwork)

```

 ***
 
# Bancos de Dados 

* Para a construção da modelagem do número de passageiros explicado pelas variáveis de origem, destino, indicadores da Covid-19 e indicadores sociais foram pesquisados e baixados:
  + Dados sobre o tráfego aéreo das companhias brasileiras no ano de 2020 na granularidade mensal do número de passageiros em cada trecho, ou seja, origem e destino.
  + Dados sobre as coordenadas geográficas dos pontos de centro dos países considerados na análise. Esses dados permitiram o cálculo da distância entre países considerada variável significativa para modelos de gravidade conforme a lei de gravitação universal de Newton. 
  + Dados sobre o número de casos e mortes de corona vírus bem como alguns dados de indicadores sociais sobre esses países na granularidade de meses do ano de 2020.

## Tráfego Áereo

* Uma pesquisa foi feita na rede mundial de computadores para encontrar dados relevantes que pudessem fornecer informações para responder a pergunta: __Como a pandemia afetou o transporte aéreo das companhias aéreas brasileiras?__ O sítio da ANAC oferece atualizações de bancos de dados disponíveis para download mensalmente. O Banco `resumo_anual_2020.csv` foi baixado no sítio [ANAC](https://www.anac.gov.br/assuntos/dados-e-estatisticas/dados-estatisticos/dados-estatisticos) e utilizado para recuperar as origens e destinos bem como a variável resposta quantidade de passageiros no período de 01-01-2020 até 31-12-2020.


### Importação   

* A importação ds dados foi realizada com a função `read_delim` do pacore `read_r`. O argumento separador foi definido como `";"`. O argumento encoding dos dados foi definido como `"windows-1252"` 


```{r warning=F, error=F, message=F}

# Declara url de dados
url_voos <- "https://raw.githubusercontent.com/Protospi/VOOS_COVID19/main/dados/resumo_anual_2020.csv"

# Declara url da linguagem da tabela
url_ptbr <- 'https://cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese.json'

# Carrega dados de 2020
voos1 <- read_delim(url_voos, 
                   ";",
                   escape_double = FALSE,
                   trim_ws = TRUE,
                   locale = locale(encoding = "windows-1252"))

# Imprime dados
renderDataTable({datatable(voos1,
                           options = list(dom = 'tip',
                                           pageLength=3,
                                           scrollX = TRUE,
                                           language = list(url = url_ptbr)),
                           caption = htmltools::tags$caption("Tabela de Dados da ANAC 2020",
                                                              style="color:black; font-weight: bold"))})
# Calcula dimesoes do banco
dim1 <- dim(voos1)

```

* A dimensão do banco original é  `r dim1[1]`  linhas por `r dim1[2]` colunas.

* A granularidade dos trechos está na unidade de meses, ou seja, o número de passageiros de cada pais origem para cada pais destino por mês.

* Diversas colunas poderiam ter sido utilizadas para tentar explicar a variação de passageiros, porém, com intuito de simplificar a análise e evitar correlação entre as variáveis foi optado por reduzir a quantidade de atributos.

### Limpeza 

* O gráfico de dados faltantes do pacote `naniar` foi utilizado para avaliar visualmente a quantidade de dados faltantes e auxiliar na tomada de decisão sobre descartes e ou imputações de dados.

* Os gráficos de antes e depois da limpeza ilustram a remoção dos dados faltantes.

```{r warning=F, error=F, message=F, fig.align='center', fig.height=6, fig.width=10}

# Declara numero das variaveis de interesse
variaveis <- c(1, 3, 5, 6, 10, 12, 16, 18, 19, 20, 21, 22, 23, 24)

# Seleciona variaveis de interesse
voos <- voos1 %>% select(all_of(variaveis))

# Renomeia variaveis
colnames(voos) <- c("empresa",
                    "nacionalidade",
                    "mes",
                    "origem",
                    "origem_pais",
                    "destino",
                    "destino_pais",
                    "natureza",
                    "grupo",
                    "passageiros_pagos",
                    "passageiros_gratis",
                    "c_paga",
                    "c_gratis",
                    "correio")

# Declara paises de Interesse
paises_alvo <- c("FRANÇA", "BRASIL", "ESTADOS UNIDOS DA AMÉRICA",
                 "BÉLGICA", "ESPANHA", "RÚSSIA", "CANADÁ", "CHILE",
                 "COLÔMBIA", "ALEMANHA", "PARAGUAI", "HOLANDA",
                 "ARGENTINA", "MÉXICO", "URUGUAI", "ITÁLIA", 
                 "CUBA", "VENEZUELA", "REINO UNIDO", "GRÉCIA",
                 "NIGÉRIA", "IRLANDA", "ANGOLA", "SUÍÇA", "ETIÓPIA",
                 "ISRAEL", "ÍNDIA", "PERU", "CHINA", "ÁFRICA DO SUL")

# Grafico para verificar remocao de faltantes
p1 <- naniar::gg_miss_var(voos1) +
        ylab("Faltantes")+
        xlab("Variaveis")+ 
        ggtitle("Antes da Limpeza")

# Remove dados faltantes
voos <- voos[complete.cases(voos),]

# Grafico para verificar remocao de faltantes
p2 <- naniar::gg_miss_var(voos) +
        ylab("Faltantes")+
        xlab("Variaveis")+
        ggtitle("Depois da Limpeza")

# Grid dos graficos de faltantes antes e depois
grid.arrange(p1, p2, ncol = 2)

# Filtra paises de origem e destino
voos <- voos %>% 
    filter(destino_pais %in% paises_alvo & origem_pais %in% paises_alvo)

# Voos limpa
voos_limpo <- voos %>% 
                select(3,5,7,10)

```

* As colunas com muitos dados faltantes ou informações de pouca relevância para a modelagem foram eliminadas do banco de dados.

* O banco foi filtrado por 23 países selecionados arbitrariamente.

* As variáveis de maior interesse como `mes`, `origem_pais`, `destino_pais` e `passageiros_pagos` foram mantidas.

```{r warning=F, error=F, message=F, fig.align='center'}

# Imprime dados
renderDataTable({ datatable(voos_limpo,
                            options = list(dom = 'tip',
                                           pageLength=3,
                                           scrollX = TRUE,
                                           language = list(url = url_ptbr)),
                            caption = htmltools::tags$caption("Tabela de Dados Limpos da ANAC",
                                                              style="color:black; font-weight: bold")) })

# Calcula dimensoes do banco limpo
dim2 <- dim(voos_limpo)

```


* As linhas ou observações das variáveis remanescentes que possuíam valores faltantes em qualquer coluna foram excluídas.

* Após a limpeza o banco ficou com a dimensão de `r dim2[1]` linhas por `r dim2[2]` colunas indicando a perda de `r dim1[1] - dim2[1]` registros e a remoção de `r dim1[2] - dim2[2]` colunas.

## Coordenadas Geográficas

* Para o cálculo das distâncias entre os países na unidade de quilômetros foi necessário pesquisar um banco de dados com as informações sobre as coordenadas geográficas dos pontos de centros dos países em graus de latitude e longitude.

* As informações sobre o ponto de centro das coordenadas geográficas de cada país foram recuperadas utilizando o banco de coordenadas geográficas do arquivo `countries.csv` baixado do sítio [developers.google](https://developers.google.com/public-data/docs/canonical/countries_csv). Porém esse banco só possuía os nomes dos países em inglês e não possuía um chave para a junção com os dados de transporte aéreo.

* Para remediar a situação um outro banco com o nome dos países em português e a variável código de duas letras dos países foi recuperado no sítio [sport-histoire](https://www.sport-histoire.fr/pt/Geografia/Codigos_ISO_Paises.php) para realizar a junção dos bancos. Essa chave possibilitou combinar as informações de transporte aéreo e coordenadas geográficas.

### Importação 

* A importação dos banco de dados foi realizada com as funções `read_delim` e `read_csv` do pacote `read_r`.

* Duas tabelas dos arquivos `paises_cod.csv` e `coord_paises.csv` foram combinadas com o código de 2 letras dos países para recuperar a informação de coordenadas dos países. Pelo fato de que o banco de coordenadas tinha os nomes dos países em inglês e o banco de tráfego aéreo em português, a junção foi feita pelo código de 2 letras de cada país utilizando esse banco de código dos nomes como acessório para ligar as informações de tráfego aéreo e coordenadas.

```{r warning=F, error=F, message=F}

# Declara url do github de paises cod
url_paises_cod <- "https://raw.githubusercontent.com/Protospi/VOOS_COVID19/main/dados/paises_cod.csv"

# Carrega codigos de paises
paises = read_csv(url_paises_cod) %>%
            select(- num)

# Declara url de coordenadas de paises no github
url_paises_coord <- "https://raw.githubusercontent.com/Protospi/VOOS_COVID19/main/dados/coord_paises.csv"

# Carrega banco de coordenadas de paises
coord_paises <- read_delim(url_paises_coord, 
                           "\t",
                           escape_double = FALSE,
                           trim_ws = TRUE)

# Adiciona coordenadas para paises e distancia euclidiana
coord <- paises %>%
          inner_join(coord_paises,
                     by = c("cod" = "country")) %>%
          select(- cod)

# Imprime dados
renderDataTable({ datatable(coord,
                            options = list(dom = 'tip',
                                           pageLength=3,
                                           scrollX = TRUE,
                                           language = list(url = url_ptbr)),
                            caption = htmltools::tags$caption("Tabela dos dados de Coordenadas Geográficas",
                                                              style="color:black; font-weight: bold")) })

# Declara dimensão das cordenadas
dim3 <- dim(coord)

```

* As colunas utilizada para as junções foram descartadas e os dados não apresentam valores faltantes e possuem dimensão de `r dim3[1]` linhas por `r dim3[2]` colunas .

* Após a operação de junção o banco de coordenadas recuperou a informação do nome dos países em inglês na coluna `name` que foi utilizada como chave para a junção com os dados da covid 19 em etapa posterior.

### Agregação e Junção

* Como o objetivo da análise foi determinar a relação entre as variáveis agrupadas por `origem_pais`, `destino_pais` e `mes`, a resposta número de passageiros foi agregada com os totais destes grupos. 

* Conforme indicado no livro texto _"Statistical Analysis of Network Data"_, a distância geográfica entre países em modelos de gravidade deve ser considerada. O autor explica que em analogia a Lei de Newton da Gravitação universal, _"é assumido que a interação entre duas populações é diretamente proporcional ao tamanho dessas populações e inversamente proporcional a sua distância"_.  

* Para o cálculo das distâncias entre países foi usada a função `distm` do pacote `geosphere` que calcula a distância entre coordenadas geográficas no planeta.

* As operações de junção entre os bancos foram realizadas com a função `left_join` do pacote `dplyr`.


```{r warning=F, error=F, message=F}

# unifica data frame com contagem de passageiros e atributos geograficos 
df_grafo_limpo <- voos_limpo %>% 
  group_by(origem_pais, destino_pais, mes) %>%
  summarise(passageiros = sum(passageiros_pagos)) %>% 
  left_join(coord,
            by = c("origem_pais" = "pais")) %>%
  left_join(coord,
            by = c("destino_pais" = "pais"),
            suffix = c(".origem",
                       ".destino")) %>% 
  filter(passageiros > 1) %>% 
  ungroup()

# Calcula distancia em kilometros
for( i in 1:nrow(df_grafo_limpo)){
  
  # Calcula distancia geospherica
  df_grafo_limpo[i, "distancia_km" ] <- round(distm(c(as.numeric(df_grafo_limpo[i, "longitude.origem"]),
                                              as.numeric(df_grafo_limpo[i, "latitude.origem"])),
                                              c(as.numeric(df_grafo_limpo[i, "longitude.destino"]),
                                              as.numeric(df_grafo_limpo[i, "latitude.destino"])),
                                              fun = distHaversine) / 1000, 2)
  
}

# Seleciona variaveis
df_grafo <- df_grafo_limpo %>% 
                select(c(1,2,3,4,7,10,11))

# Imprime dados
renderDataTable({ datatable(df_grafo, options = list(dom = 'tip',
                                                 pageLength=3,
                                                 scrollX = TRUE,
                                                 language = list(url = url_ptbr)),
                            caption = htmltools::tags$caption("Tabela de Agregação de Junção",
                                                              style="color:black; font-weight: bold")) })

# Declara dimensão do banco df_grafo
dim4 <- dim(df_grafo)

```

* Após as operações de agregações e filtros, o banco apresentou a dimensão de `r dim4[1]` linhas ou observações da soma de passageiros nos `r dim1[1]` vôos agrupados em `origem_pais`, `destino_pais` e `mes` por `r dim4[2]` colunas que representam as variáveis resposta e explicativas.

* Duas junções foram feitas para recuperar as coordenadas da origem e do destino dos aviões.

* As colunas com coordenadas geográficas foram removidas após o cálculo da distância entre o centro dos países.

***

## Covid 19 e Indicadores Sociais

* Para recuperar a informação sobre o número de casos e mortes por país e mês, bem como indicadores sociais dos países foi realizada uma pesquisa na rede mundial de computadores e os dados agregados foram baixados no sítio [ourworldindata](https://ourworldindata.org/coronavirus#which-countries-are-making-progress-against-the-pandemic).

* O sítio ourworldindata atualiza os dados de mortes e novos casos ao longo da pandemia, usando como fonte o Instituto de pesquisa [Jonh Hopkins](https://coronavirus.jhu.edu/map.html).

### Importação dos Dados

* A importação dos dados foi realizada com o pacore `read_r` da biblioteca `tidyverse`.

* Pelo fato da fonte ser internacional os nomes das colunas estão na língua inglesa.

```{r warning=F, error=F, message=F}

# Carrega dados Da covid
covid_19 <- read_csv("https://raw.githubusercontent.com/Protospi/VOOS_COVID19/main/dados/covid_na.csv")

# Imprime dados
renderDataTable({ datatable(covid_19, options = list(dom = 'tip',
                                                 pageLength = 3,
                                                 scrollX = TRUE,
                                                 language = list(url = url_ptbr)),
                            caption = htmltools::tags$caption("Tabela dos dados da Covid 19 e
                                                               Indicadores Sociais",
                                                              style="color:black; font-weight: bold")) })

# Declara dimensão de covid 19
dim5 <- dim(covid_19)

```

* Os dados originais apresentaram a dimensão de `r dim5[1]` linhas por `r dim5[2]` colunas.

* Diversas colunas de variáveis sociais como dados sobre mortes e casos, bem como IDH, população e expectativa pareceram promissoras para análise.

### Limpeza dos Dados

* O Gráfico de dados faltantes do pacote `naniar` foi utilizado para ilustrar a limpeza realizada no banco.

```{r warning=F, error=F, message=F, fig.align='center', fig.height=8, fig.width=10}

# Separa banco covid
covid <- covid_19 %>% 
          replace_na(list(total_deaths  = 2,
                          new_deaths  = 2,
                          new_cases = 2,
                          total_cases = 2)) %>% 
          mutate(mes = month(date)) %>% 
          group_by(location, mes) %>% 
          summarise(new_cases = sum(new_cases),
                    total_cases = max(total_cases),
                    new_deaths = sum(new_deaths),
                    total_deaths = max(total_deaths),
                    gdp_per_capita = mean(gdp_per_capita),
                    human_development_index = mean(human_development_index),
                    population = mean(population),
                    life_expectancy = mean(life_expectancy)) %>% 
          ungroup()

# Grafico para verificar remocao de faltantes
p3 <- gg_miss_var(covid_19) +
        ylab("Faltantes")+
        xlab("Variaveis")+ 
        ggtitle("Antes da Limpeza")

# Grafico para verificar remocao de faltantes
p4 <- gg_miss_var(covid) +
        ylab("Faltantes")+
        xlab("Variaveis")+ 
        ggtitle("Depois da Limpeza")

# Grid dos graficos de faltantes antes e depois
grid.arrange(p3, p4, ncol = 2)

```

* As variáveis de interesse com informações sobre casos e mortes e indicadores sociais como IDH, população, renda per capta e explicativa de vida foram extraídas para a análise porque parecem ser as mais representativas  para explicar a variação no volume de passageiros ao longo do tempo na pandemia do COVID 19.  

```{r warning=F, error=F, message=F}

# Imprime dados
renderDataTable({ datatable(covid, options = list(dom = 'tip',
                                                 pageLength = 3,
                                                 scrollX = TRUE,
                                                 language = list(url = url_ptbr)),
                            caption = htmltools::tags$caption("Tabela dos dados da Covid 19 e
                                                               Indicadores Sociais Limpos",
                                                              style="color:black; font-weight: bold")) })

# Dimensão do banco covid 19
dim6 <- dim(covid)

```

* A informações sobre a covid 19 ficaram representada pelo banco com dimensões de `r dim6[1]` linhas por `r dim6[2]` colunas. 

* Os registros de trechos de voo das variáveis com valores do tipo NA possivelmente representavam a ausência de teste nos primeiros meses de 2020 e foram imputadas com a constante zero 0 para novos casos e mortes aproximando pelo fato de que os casos mesmo que existentes eram poucos.

* A variáveis selecionadas incluíram a variável `location` que foi utilizada como chave estrangeira na etapa de pré-processamento dos dados para aplicar a junção com os dados de transporte aéreo e formar o banco de dados final que foi utilizado nas etapas de análise descritiva e modelagem.


## Banco Final

* Portanto o banco final recupera a informação de 3 bancos de dados distintos.
  + Banco de dados de Transporte Aéreo de companhias brasileiras em 2020.
  + Banco de dados da distância em quilômetros entre os centros dos países.
  + Banco de dados da Covid-19 no ano de 2020.

### Junção

* Nesta etapa foi realizada a operação de junção com a função `left_join` do pacote `dplyr` sobre os bancos com informações sobre o transporte aéreo e estatísticas da Covid-19. Também foi realizada a remoção de colunas ou registros com dados faltantes.

```{r warning=F, error=F, message=F, fig.align='center'}

# Unifica Data frame com atributos do covid e sociais
df_g <- df_grafo %>% 
            left_join(covid, by = c("name.origem" = "location", "mes" = "mes")) %>% 
            replace_na(list(total_deaths  = 0,
                            new_deaths  = 0,
                            new_cases = 0,
                            total_cases = 0)) %>% 
            left_join(covid, by = c("name.destino" = "location", "mes" = "mes"),
                      suffix = c(".origem", ".destino")) %>% 
                      replace_na(list(total_deaths  = 0,
                                      new_deaths  = 0,
                                      new_cases = 0,
                                      total_cases = 0)) %>% 
            select(-name.origem, name.destino) %>% 
            ungroup()

# Remove dados faltantes
df_g <- df_g[complete.cases(df_g), - 5]

# Renomeia colunas do covid
df_g <- df_g %>% 
          rename(novos_casos_origem = new_cases.origem,
                 total_casos_origem = total_cases.origem,
                 novas_mortes_origem = new_deaths.origem,
                 total_mortes_origem = total_deaths.origem,
                 novos_casos_destino = new_cases.destino,
                 total_casos_destino = total_cases.destino,
                 novas_mortes_destino = new_deaths.destino,
                 total_mortes_destino = total_deaths.destino,
                 pib_origem = gdp_per_capita.origem,
                 idh_origem = human_development_index.origem,
                 populacao_origem = population.origem,
                 expectativa_vida_origem = life_expectancy.origem,
                 pib_destino = gdp_per_capita.destino,
                 idh_destino = human_development_index.destino,
                 populacao_destino = population.destino,
                 expectativa_vida_destino = life_expectancy.destino)

# Imprime dados
renderDataTable({ datatable(df_g, options = list(dom = 'tip',
                                                 pageLength = 3,
                                                 scrollX = TRUE,
                                                 language = list(url = url_ptbr)),
                            caption = htmltools::tags$caption("Tabela dos dados da jução entre ANAC,
                                                              Covid-19 e Indicadores Sociais",
                                                              style="color:black; font-weight: bold")) })

# Dimensao do banco final
dim7 <- dim(df_g)

```


* As tabelas de voos e Covid-19 foram combinadas usando as chaves, `name = location` e `mes = mes`. Após a junção a variável `name` foi removida.

* Os registros faltantes foram removidos.

* As colunas com informações sobre a Covid-19 e Indicadores Sociais foram renomeadas para o português.

* O banco final `df_g` ficou com dimesão de `r dim7[1]` linhas por `r dim7[2]` colunas.

***

# Análise Descritiva

* A análise descritiva foi dividida em visualizações dos grafos, visualização das variáveis resposta e explicativas e estatísticas da rede de relações de transporte de passageiros entre os países.

## Visualizações da Rede

* Dois grafos foram construídos com objetivo de ilustrar a disposição das relações de transporte dos passageiros entre países operados por companhias aéreas brasileiras. O primeiro utiliza o mapa do mundo para poder ilustrar a localização geográfica das relações. O segundo desconsidera as coordenadas e direciona o foco para volume de passageiros e estatísticas da rede. 

### Grafo no Mapa

* O grafo no mapa mundial considera os trechos de voo operados por companhias aéreas brasileiras entre países para todos os meses do ano de 2020. O gradiente da cor verde ilustra a força dos vértices, sendo o verde mais escuro para os vértices com maior força na rede. A força é uma estatística da soma dos pesos (número de passageiros) das arestas adjacentes a cada vértice.


```{r warning=F, error=F, message=F, eval = F, fig.align='center', fig.height=6, fig.width=9}

# Declara grafo
g <- graph_from_data_frame(df_g, directed=T)

# Define Layout
l <- layout_with_kk(g)

# Define tamanho dos vertices
igraph_options(vertex.size=10)

# Decora rotulos com nomes
V(g)$label <- V(g)$name

# Tamanho do vertice proporcional a forca
V(g)$size <- 4*sqrt(strength(g))
V(g)$size2 <- V(g)$size * .5

# Peso das arestas por atividades em comum
E(g)$width <- log(df_g$passageiros) / 5

# Altera labels menores para 0
V(g)$label.dist <- ifelse(V(g)$size >= 5, 0, 1.0)

# Simplifica grafo
g_2 <- igraph::simplify(g, remove.multiple = TRUE,
                        edge.attr.comb = list(weight = "sum"))

# Mapa mundi
mapa_mundo <- map_data(map = "world") %>%
  filter(region != "Antarctica")

# Data frame de graus
graus <- tibble(pais = names(degree(g)),
                graus = log(degree(g),10) %>%  as.vector())

# Calcula grau de centralidade
graus_mapa <- mapa_mundo %>% 
  left_join(coord, by = c("region"="name")) %>% 
  full_join(graus, by = c("pais" = "pais"))

# Declara vetor de paises selecionados
paises <- c("ÁFRICA DO SUL","ALEMANHA","ARGENTINA",
            "BRASIL","CANADÁ","CHILE",                    
            "CHINA","COLÔMBIA","ESPANHA",                  
            "ESTADOS UNIDOS DA AMÉRICA","ETIÓPIA","FRANÇA",
            "HOLANDA","ISRAEL","ITÁLIA",
            "MÉXICO","PARAGUAI","PERU",                  
            "REINO UNIDO","SUÍÇA","URUGUAI",                  
            "VENEZUELA","ANGOLA")

# Filtra coordenadas
coords <- coord %>%
            filter(pais %in% paises)

# Desenha gráfico geospacial
ggplot() +
  geom_polygon(data = graus_mapa,
               aes(long, lat, group = group, fill = graus), 
               show.legend = FALSE,
               alpha = 0.6,
               color = "white") +
  scale_fill_viridis_b(name="", na.value = "lightgray") +
  geom_segment(data = df_grafo_limpo, 
               aes(x = longitude.origem, xend = longitude.destino,
                   y = latitude.origem, yend = latitude.destino),
               # arrow = arrow(length = unit(0.1, "inches"), # optional arrows
               # type = "closed"),
               size = 0.25,
               alpha = 0.5) +
  geom_point(data = coords,
             aes(longitude, latitude), color = "red") +
  theme(axis.line = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank()) +
  labs(title = "Rede de Relações Geoespacial do Tráfego Aéreo de Companhias Brasileiras")

```

![](mapa_mundi.png)

* Observou-se que o Brasil é vértice com maior número de passageiros dentre todos os vértices, o que era esperado considerando que os dados são das companhias aéreas brasileiras. É razoável também ressaltar que tal fato pode prejudicar a estimação do número de passageiros devido ao fato de que da quantidade brasileira pertence a uma escala diferente dos demais países. A Solução de transformação da escala de passageiros para escala logarítmica pode ser uma possível solução.

### Grafos por Intervalo de Meses

* O grafo interativo da rede por intervalo de meses foi construído usando funções do pacote `shiny`. O objetivo deste grafo foi ilustrar as relações entre os países desconsiderando as coordenadas geográficas. A escolha do intervalo de meses permite granularizar o grafo para observar detalhes no volume de passageiros.

* A grossura das arestas considerou o volume de passageiros na escala logarítmica com base 10. O botão de estatísticas permite alterar o tamanho dos vértices baseado na estatística escolhida.

* Os ícones das bandeiras dos países foram baixados no sítio [flaticon](https://www.flaticon.com/)

<center>

```{r warning=F, error=F, message=F, fig.align='right', fig.height=10, fig.width=10}

renderVisNetwork({
  
  # Filtra o mês
  df_g_mes = df_g %>% 
              filter(mes >= input$mes[1] & mes <= input$mes[2]) %>% 
              group_by(origem_pais, destino_pais) %>% 
              summarise(passageiros = sum(passageiros))
  
  # Declara grafo
  g <- graph_from_data_frame(df_g_mes, directed=T)
  
  # Condicao da estatistica de centralidade
  if(input$centralidade == "graus"){
    
    est <-  log(igraph::degree(g), 10) %>%  as.vector()
    
  } else if(input$centralidade == "proximidade"){
    
    est <-  igraph::closeness(g) %>%  as.vector()
    
  } else if(input$centralidade == "mediacao"){
    
    est <-  igraph::betweenness(g) %>%  as.vector()
    
  } else if(input$centralidade == "forca"){
    
    est <-  4*sqrt(igraph::strength(g)) %>%  as.vector()
      
  } 
  
  
  # Lista de enderecos das imagens
  caminho <- "https://raw.githubusercontent.com/Protospi/VOOS_COVID19/main/icone_bandeira_paises/"
  
  # Declara lista de paises
  paises_lista <- tibble(id = 1:23,
                         paises = c("ÁFRICA DO SUL","ALEMANHA","ANGOLA","ARGENTINA",                
                                    "BRASIL","CANADÁ","CHILE","CHINA",                    
                                    "COLÔMBIA","ESPANHA","ESTADOS UNIDOS DA AMÉRICA","ETIÓPIA",
                                    "FRANÇA","HOLANDA","ISRAEL","ITÁLIA",                   
                                    "MÉXICO","PARAGUAI","PERU","REINO UNIDO",              
                                    "SUÍÇA","URUGUAI","VENEZUELA" )) 
  
  # Declara vertices da rede
  vertices <- tibble(id =paises_lista[paises_lista$paises %in% V(g)$name,"id"] %>%  pull(),
                     nomes = V(g)$name)
  
  nodes <- data.frame(id = as.numeric(unlist(vertices$id)), 
                      shape =  rep("circularImage", length(vertices$id)),
                      image = paste0(caminho, unlist(vertices$id), ".png"),
                      label = vertices$nomes,
                      value = est)
  
  # Declara origem destino
  origem_destino <- df_g_mes %>%  
                      left_join(vertices, by = c("origem_pais" = "nomes")) %>% 
                      left_join(vertices, by = c("destino_pais" = "nomes"),
                                suffix = c("_from", "_to")) %>% 
                      select(3:5)
  
  edges <- data.frame(from = origem_destino$id_from,
                      to = origem_destino$id_to,
                      width = log(origem_destino$passageiros, 10))
  
  visNetwork(nodes, edges) %>% 
    visNodes(shapeProperties = list(useBorderWithImage = TRUE)) %>%
    visLayout(randomSeed = 2)

})


fluidRow(
  
  # Linha com 4 colunas
  column(4,
         
        # Define entrada
        sliderInput("mes",
                    "Escolha o Intervalo de meses",
                    min = 1,
                    max = 12,
                    value = c(2,8))
         
         ),
  
   # Linha com 4 colunas
  column(4,
         
         # Seletor de paises
         selectInput("centralidade",
                     "Selecione a Estatística de Centralidade",
                     choices = c("Graus" = "graus",
                                 "Proximidade" = "proximidade",
                                 "Mediação" = "mediacao",
                                 "Força" = "forca"
                                 ))
         )

)



```

</center>

* Observou-se uma queda expressiva de passageiros e trechos se comparados os grafos do mês 1 ao 3 e do mês 5 ao 7.

* Depois do mês 7 parece ocorrer uma retomada no número de passageiros, porém com volumes aparentemente menores do que os apresentados no primeiro trimestre.

* A estatística de graus, mediação, proximidade e força, como esperado, é predominantemente brasileira. Excluindo o Brasil, pais na América Latina parece apresentar grau e força maiores que os demais países.

## Visualizações das Variáveis

* Gráficos da linha do tempo, distribuição das variáveis, resposta versus explicativas e contagem de passageiros por trecho foram construídos com intuito de explorar as variáveis explicativas e suas relações com a variável resposta.

### Linha do Tempo

* Para observar a flutuação das variáveis explicativas ao longo do tempo foi construído um gráfico interativo com o pacote `shiny` que permite a observar a contagem da variável selecionada ao longo da linha do tempo que compreende os meses do ano 2020 granularizada por pais.

* A escala logarítmica na base 10 foi utilizada como transformação dos dados.


```{r warning=F, error=F, message=F, fig.align='center'}

fluidRow(
    
    # Coluna de 4
    column(4,
           
      # Seleciona trechos
        selectInput("origem_tempo",
                    " Selecione o Pais",
                    choices = c("ÁFRICA DO SUL","ALEMANHA","ARGENTINA",
                                "BRASIL","CANADÁ","CHILE",                    
                                "CHINA","COLÔMBIA","ESPANHA",                  
                                "ESTADOS UNIDOS DA AMÉRICA","ETIÓPIA","FRANÇA",
                                "HOLANDA","ISRAEL","ITÁLIA",
                                "MÉXICO","PARAGUAI","PERU",                  
                                "REINO UNIDO","SUÍÇA","URUGUAI",                  
                                "VENEZUELA","ANGOLA"),
                    selected = "BRASIL")
    ),
    
    # Coluna de 4
    column(4,
           
      # Seleciona variavel de comparação
    selectInput("variavel_tempo",
                "Escolha a variável Explicativa",
                choices = c("Passageiros" = "passageiros",
                            "Novas Mortes" = "novas_mortes",
                            "Total Mortes" = "total_mortes",
                            "Novos Casos" = "novos_casos",
                            "Total de Casos" = "total_casos"))
    )
)

# Renderiza grafico interativo
renderPlot({
  
  # Numero de passageiros origem
  passageiros_o <- df_g %>% 
                    group_by(origem_pais, mes) %>% 
                    summarise(passageiros_o = sum(passageiros))
  
  # Numero de passageiros destino
  passageiros_d <- df_g %>% 
                    group_by(destino_pais, mes) %>% 
                    summarise(passageiros_d = sum(passageiros))
  
  # Total de passageiros
  total_passageiros <- passageiros_o %>% 
                          inner_join(passageiros_d, by = c("origem_pais" = "destino_pais", "mes" = "mes")) %>%
                          group_by(mes, origem_pais) %>% 
                          mutate(passageiros = sum(passageiros_o + passageiros_d)) %>% 
                          select(1,2,5)
  
  # Filtra o mês
  df1 <- covid %>% 
          left_join(coord, by = c("location" = "name")) %>% 
          select(2,11, 3:6) %>% 
          group_by(mes, pais) %>% 
          summarise(total_mortes  = sum(new_cases),
                    novas_mortes  = sum(total_cases),
                    novos_casos = sum(new_deaths),
                    total_casos = sum(total_deaths)) %>% 
          inner_join(total_passageiros, by = c("mes" = "mes", "pais" = "origem_pais")) %>% 
          ungroup() %>% 
          mutate(mes = factor(mes,
                              levels = 1:12,
                              labels = c("Janeiro",
                                         "Fevereiro",
                                         "Março",
                                         "Abril",
                                         "Maio",
                                         "Junho",
                                         "Julho",
                                         "Agosto",
                                         "Setembro",
                                         "Outubro",
                                         "Novembro",
                                         "Dezembro"),
                              ordered=T)) %>% 
          filter(pais == input$origem_tempo) %>% 
          mutate(total_mortes  = total_mortes + 1,
                 novas_mortes  = novas_mortes + 1,
                 novos_casos = novos_casos + 1,
                 total_casos = total_casos + 1) %>% 
          mutate_if(is.numeric, function(x){log(x, 10)}) %>% 
          ungroup() 
          
  
          
  # Desenha histograma de variaveis
  ggplot(data = df1, aes_string(x ="mes", y = input$variavel_tempo, group = 1))+
    geom_line(color = "green", size=1.1)+
    geom_point(color = "darkgreen", size = 3)+
    xlab("Meses")+
    ylab(bquote(Log[10](.(input$variavel_tempo))))+
    ggtitle("Linha do Tempo das Variáveis") + 
    theme(plot.title = element_text(size = 20, face = "bold"),
          axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1, size = 10))
  
})

```

* É possível observar que o número de passageiros atinge o mínimo em abril para diversos países. Esse fato pode ser explicado pelas políticas de fechamento dos espaços aéreos. A partir de abril pode-se observar uma retomada no crescimento do volume de passageiros, porém ainda inferiores aos primeiros meses onde os governos não haviam decretado as medidas de restrição.

* As variáveis mortes e casos parecem estar correlacionadas com a diminuição no fluxo de passageiros. Tal fato indica que as variáveis do Covid-19 podem desempenhar o papel de explicar a flutuação na demanda e também podem capturar as políticas de fechamento de cada pais dado que não foi encontrado na forma estruturada dentro da rede mundial de computadores.


### Histograma das Variáveis

* Para inspecionar a distribuição das variáveis a interatividade do pacote `shiny` foi utilizada possibilitando a escolha de qual variável será visualizada. Como os trechos sem Brasil na origem e destino apresentam escalas muito diferentes dos trechos onde o Brasi foi origem ou destino o botão de filtro permite a visualização por grupos ou todos juntos. O botão de intervalo de meses também foi disponibilizado para fragmentar a analise por intervalo de meses. Por último um botão para escolha da variável a ser explorada foi disponibilizado.

* A escala logarítmica na base 10 foi utilizada como transformação dos dados devido as diferenças de ordem de escala entre os países.

```{r warning=F, error=F, message=F, fig.align='center'}

fluidRow(
  
    # Coluna de 4
    column(4,
           
      # Seletor de paises
      selectInput("paises_hist",
                  "Selecione os países",
                  choices = c("Brasil na Origem ou Destino" = "p1",
                              "Sem Brasil" = "p2",
                              "Todos" = "p3"))
    ),
    
    # Coluna de 4
    column(4,
           
      # Define entrada
      sliderInput("mes2_hist",
                  "Escolha o Intervalo de meses",
                  min = 1,
                  max = 12,
                  value = c(1,6))
    ),
    
    # Coluna de 4
    column(4,
           
      # Seleciona variavel de comparação
    selectInput("variavel_hist",
                "Escolha a variável Explicativa",
                choices = c("Passageiros" = "passageiros",
                            "Distância Km" = "distancia_km",
                            "Total de Casos Origem" = "total_casos_origem",
                            "Total Mortes Origem" = "total_mortes_origem",
                            "Novos Casos Origem" = "novos_casos_origem",
                            "Total de Casos Origem" = "total_casos_origem",
                            "Novas Mortes Origem" = "novas_mortes_origem",
                            "Total de Mortes Origem" = "total_mortes_origem",
                            "Renda per Capta Origem" = "pib_origem",
                            "Indica de Desenvolvimento Humano Origem" = "idh_origem",
                            "População Origem" = "populacao_origem",
                            "Expectativa de vida Origem" = "expectativa_vida_origem",
                            "Total de Casos Destino" = "total_casos_destino",
                            "Total Mortes Destino" = "total_mortes_destino",
                            "Novos Casos Destino" = "novos_casos_destino",
                            "Total de Casos Destino" = "total_casos_destino",
                            "Novas Mortes Destino" = "novas_mortes_destino",
                            "Total de Mortes Destino" = "total_mortes_destino",
                            "Renda per Capta Destino" = "pib_destino",
                            "Indica de Desenvolvimento Humano Destino" = "idh_destino",
                            "População Destino" = "populacao_destino",
                            "Expectativa de vida Destino" = "expectativa_vida_destino"))
    )
)

# Renderiza grafico interativo
renderPlot({
  
  if(input$paises_hist == "p1"){
    
    # Somente quando brasil esta em origem ou destino
    df <- df_g %>%
      filter((origem_pais == 'BRASIL' & !destino_pais == 'BRASIL') |
               (!origem_pais == 'BRASIL' & destino_pais == 'BRASIL')) 
    
  } else if(input$paises_hist == "p2"){
    
    # Remove Brasil
    df <- df_g %>%
      filter(!origem_pais == 'BRASIL' & !destino_pais == 'BRASIL')
    
  } else if(input$paises_hist == "p3"){
    
    # Todos
    df <- df_g 
    
  }
  
  # Filtra o mês
  df = df %>% filter(mes >= input$mes2_hist[1] & mes <= input$mes2_hist[2])
  
  # Trasforma em log variaveis de interesse
  df <- df %>% 
         mutate(total_mortes_origem  = total_mortes_origem + 1,
               novas_mortes_origem  = novas_mortes_origem + 1,
               novos_casos_origem = novos_casos_origem + 1,
               total_casos_origem = total_casos_origem + 1,
               total_mortes_destino  = total_mortes_destino + 1,
               novas_mortes_destino  = novas_mortes_destino + 1,
               novos_casos_destino = novos_casos_destino + 1,
               total_casos_destino = total_casos_destino + 1,
               distancia_km = distancia_km  + 1) %>% 
  mutate_if(is.numeric, function(x){log(x, 10)})
  
  # Desenha histograma de variaveis
  ggplot(data = df, aes_string(x = input$variavel_hist))+
   geom_histogram(fill = "darkgreen", color = "black")+
    xlab(bquote(Log[10](.(input$variavel_hist))))+
    ylab("Frequência")+
    ggtitle("Histograma das Variáveis") + 
    theme(plot.title = element_text(size = 20, face = "bold"))
  
})

```

* Foi possível observar que nos meses de 1 a 3 a escala logarítmica dos passageiros diversos trechos atingem valores na ordem de 4, ou seja, 10000 passageiros. Porém no intervalo de meses de 5 a 8 os trechos se concentram na escala de 2 e 3, ou seja 100 e 1000 passageiros.

* A distância entre países se concentra entre 1000 e 10000 quilômetros não havendo alteração significativa com a alteração do intervalo de meses na distância mas somente na frequência o que indica que os trechos foram mantido porém com um número reduzido de passageiros.

* Se consideradas as variáveis do Covid-19 é possível observar o aumento expressivo do primeiro para o segundo semestre.

* Como esperado as variáveis de indicadores socioeconômicos não apresentaram grandes mudanças ao longo do tempo.

### Log Explicativa vs Log Passageiros

* Foi elaborado o gráfico de comparação entre as potenciais variáveis explicativas e a resposta para avaliar se existia uma tendência de queda ao longo do ano de 2020 no número de passageiros.

* Devido as diferenças de escala foi utilizada a escala logarítmica com base 10 na resposta e nas explicativas para acomodar as ordens de grandeza das escalas.

* O função de suavização `geom_smooth(method = "lm")` com método de modelo linear do pacote __ggplot2__ foi utilizada para capturar a tendência geral da flutuação do número de passageiros ao longo do tempo por meio da ilustração gráfica.

* As opções de seleção e segmentação do banco por países com Brasil no destino e origem , sem Brasil e todos os dados foi implementada para visualizar a tendência com e sem a influência do grupo majoritário. Botões para selecionar intervalo de meses e variável explicativa também foram implementados para granularizar os cenários.

```{r warning=F, error=F, message=F, fig.align='center'}

fluidRow(
  
    # Coluna de 4
    column(4,
           
      # Seletor de paises
      selectInput("paises",
                  "Selecione os países",
                  choices = c("Brasil na Origem ou Destino" = "p1",
                              "Sem Brasil" = "p2",
                              "Todos" = "p3"))
    ),
    
    # Coluna de 4
    column(4,
           
      # Define entrada
      sliderInput("mes2",
                  "Selecione o Intervalo de meses",
                  min = 1,
                  max = 12,
                  value = c(1,6))
    ),
    
    # Coluna de 4
    column(4,
           
      # Seleciona variavel de comparação
    selectInput("variavel",
                "Selecione a Variável Explicativa",
                choices = c("Distância Km" = "distancia_km",
                            "Total de Casos Origem" = "total_casos_origem",
                            "Total Mortes Origem" = "total_mortes_origem",
                            "Novos Casos Origem" = "novos_casos_origem",
                            "Total de Casos Origem" = "total_casos_origem",
                            "Novas Mortes Origem" = "novas_mortes_origem",
                            "Total de Mortes Origem" = "total_mortes_origem",
                            "Renda per Capta Origem" = "pib_origem",
                            "Indica de Desenvolvimento Humano Origem" = "idh_origem",
                            "População Origem" = "populacao_origem",
                            "Expectativa de vida Origem" = "expectativa_vida_origem",
                            "Total de Casos Destino" = "total_casos_destino",
                            "Total Mortes Destino" = "total_mortes_destino",
                            "Novos Casos Destino" = "novos_casos_destino",
                            "Total de Casos Destino" = "total_casos_destino",
                            "Novas Mortes Destino" = "novas_mortes_destino",
                            "Total de Mortes Destino" = "total_mortes_destino",
                            "Renda per Capta Destino" = "pib_destino",
                            "Indica de Desenvolvimento Humano Destino" = "idh_destino",
                            "População Destino" = "populacao_destino",
                            "Expectativa de vida Destino" = "expectativa_vida_destino"),
                selected = "Total de Casos Origem")
    )
)

# Renderiza grafico interativo
renderPlot({
  
  if(input$paises == "p1"){
    
    # Somente quando brasil esta em origem ou destino
    df <- df_g %>%
      filter((origem_pais == 'BRASIL' & !destino_pais == 'BRASIL') |
               (!origem_pais == 'BRASIL' & destino_pais == 'BRASIL')) 
    
  } else if(input$paises == "p2"){
    
    # Remove Brasil
    df <- df_g %>%
      filter(!origem_pais == 'BRASIL' & !destino_pais == 'BRASIL')
    
  } else if(input$paises == "p3"){
    
    # Todos
    df <- df_g 
    
  }
  
  # Filtra o mês
  df = df %>% filter(mes >= input$mes2[1] & mes <= input$mes2[2])
  
  # Trasforma em log variaveis de interesse
  df <- df %>% 
         mutate(total_mortes_origem  = total_mortes_origem + 1,
               novas_mortes_origem  = novas_mortes_origem + 1,
               novos_casos_origem = novos_casos_origem + 1,
               total_casos_origem = total_casos_origem + 1,
               total_mortes_destino  = total_mortes_destino + 1,
               novas_mortes_destino  = novas_mortes_destino + 1,
               novos_casos_destino = novos_casos_destino + 1,
               total_casos_destino = total_casos_destino + 1,
               distancia_km = distancia_km  + 1) %>% 
         mutate_if(is.numeric, function(x){log(x, 10)})
  
  # Desenha gráfico suavizado relação passageiros covariável
  ggplot(data = df, aes_string(x = input$variavel, y = "passageiros"))+
    geom_point(color = "darkgreen", size = 3, alpha = 0.3)+
    geom_smooth(method = "lm")+
    xlab(bquote(Log[10](.(input$variavel))))+
    ylab(bquote(Log[10]("Passageiros")))+
    ggtitle("Suavizador de modelo Linear Resposta ~ Explicativa") + 
    theme(plot.title = element_text(size = 20, face = "bold"))
  
})

```

* Tanto para número de mortos como para o total de casos nos trechos em que o Brasil está na origem como no destino, foi possível observar uma queda de 4 para 3 pontos na escala logarítmica do número de passageiros nos 6 primeiros meses. Transformando de volta para a escala original, o aumento de mortes de 0 para 10000 indicou a tendência de relação linear de queda na demanda de passageiros de aproximadamente 10000 indivíduos. 

* Para os trechos que não envolvem o Brasil como país de origem ou destino observou-se também uma tendência de queda de aproximadamente 300 passageiros nos mesmos 6 primeiros meses.

* No período dos meses 7 ao 12, ou seja, no segundo semestre de 2020, observou-se uma queda menor de passageiros entre países, desconsiderando o Brasil. Porém foi possível observar a tendência de um aumento linear da ordem de aproximadamente 1000 passageiros quando considerado o Brasil como pais de origem ou destino para ambas as variáveis explicativas. 

* O cenário que considerou todos os países apresentou resultados semelhantes ao cenário com Brasil como origem ou destino dos trechos. Tal constatação provavelmente se deve ao fato de que a maioria das operações das companhias aéreas brasileiras ocorrem com o Brasil na origem ou no destino.


### Contagem do Número de Passageiros

* Para contagem do número de passageiros em cada trecho foi desenvolvido um gráfico de barras com o pacote  `shiny` que possibilita a escolha do país, a direção, ou seja, se o país seria considerado como destino ou origem e o intervalo de meses considerado na visualização.

* Como o Brasil apresenta um número de passageiros muito maior que o restante da amostra, o número de passageiros foi considerado na escala logarítmica com base 10.


```{r warning=F, error=F, message=F, fig.align='center', fig.height=8, fig.width=9}

fluidRow(
  
  # Linha com 4 colunas
  column(4,
         
         # Seleciona trechos
        selectInput("trecho",
                    " Selecione o Pais",
                    choices = c("ÁFRICA DO SUL","ALEMANHA","ARGENTINA",
                                "BRASIL","CANADÁ","CHILE",                    
                                "CHINA","COLÔMBIA","ESPANHA",                  
                                "ESTADOS UNIDOS DA AMÉRICA","ETIÓPIA","FRANÇA",
                                "HOLANDA","ISRAEL","ITÁLIA",
                                "MÉXICO","PARAGUAI","PERU",                  
                                "REINO UNIDO","SUÍÇA","URUGUAI",                  
                                "VENEZUELA","ANGOLA"),
                    selected = "BRASIL")
         
         ),
  
   # Linha com 4 colunas
  column(4,
         
         # Seletor de paises
         selectInput("direcao",
                     "Selecione Sentido",
                     choices = c("Origem" = "origem",
                                 "Destino" = "destino"))
         ),
  
   # Linha com 4 colunas
  column(4,
         
         # Define entrada
         sliderInput("mes3",
                     "Selecione o Intervalo de Meses",
                     min = 1,
                     max = 12,
                     value = c(1,6))
         
         )

)

# Renderiza grafico interativo
renderPlot({
  
  if(input$direcao == "origem"){
    
    # Combina variaveis origem destino
    df_trecho <- df_g %>% 
      mutate(trecho = paste0(origem_pais, 
                             " - > ",
                             destino_pais)) %>% 
      filter(str_detect(input$trecho, origem_pais))
    
  } else if(input$direcao == "destino") {
    
    # Combina variaveis origem destino
    df_trecho <- df_g %>% 
      mutate(trecho = paste0(origem_pais, 
                             " -> ",
                             destino_pais)) %>% 
      filter(str_detect(input$trecho, destino_pais))
    
  }
  
  # Filtra o mês
  df_trecho = df_trecho %>% filter(mes >= input$mes3[1] & mes <= input$mes3[2])

  # Exploratoria de numero de passageiros
  ggplot(data = df_trecho, aes (x=trecho, y=log(passageiros, 10))) +        
    geom_bar(position = position_dodge(), stat = "identity", fill = "darkgreen", color = "darkgreen") + 
    coord_flip () + 
    scale_x_discrete(name = "", position = "top") +    
    scale_y_continuous(name = bquote(Log[10]("Passageiros")),
                       breaks = seq(0, 17, by = 1), 
                       labels = seq(0,  17, by =  1))+
    ggtitle("Contagem do Número de Passageiros") + 
    theme(plot.title = element_text(size = 20, face = "bold"))  
  
}, width=900, height=500)

```

* O gráfico de barras auxiliou para confirmar e quantificar as evidências exibidas no grafo por intervalo de meses.

* Foi possível constatar também as mesmas quedas no número de passageiros se comparados os meses de 1 a 3 e de 4 a 6 em praticamente todos os países.

* É interessante notar também a queda no número de rotas ou trechos. Por exemplo o Chile era operado por 6 rotas como origem e destino no primeiro semestre e passou a ser operado somente por 3 no segundo semestre.

***

## Estatísticas

* Foram consideradas estatísticas descritivas das redes de relações indicadas no livro _"Introdução aos Grafos Aleatórios"_ para identificar algumas características da rede de transporte aéreo das companhias brasileiras em 2020.

### Distribuição dos Graus

* Para visualizar a distribuição dos graus da rede de transporte aéreo foi construído um histograma dos graus dos países(vértices).

* Um gráfico de dispersão da intensidade dos graus dos vértices contra o logaritmo base 10 do grau do vértice também foi implementado para compensar a ordem das escalas.

```{r warning=F, error=F, message=F, fig.align='center'}

# Declara grafo
g <- graph_from_data_frame(df_g, directed=T)

# Grafico 7
p7 <- ggplot(tibble(graus = degree(g)), aes(x = graus))+
        geom_histogram(fill = "darkgreen",
                       color = "black")+
        xlab("Graus dos Vertices")+
        ylab("Frequência")+
        ggtitle("Histograma de Graus dos Vértices") + 
        theme(plot.title = element_text(size = 20, face = "bold")) 


# Indice
ind <- (degree_distribution(g) != 0)

# Grafico 8
p8 <- ggplot(tibble(vertice =  (1:max(degree(g))-1)[ind],
                    grau =  degree_distribution(g)[ind]),
             aes(x = vertice,
                 y = grau))+
        geom_point(color = "darkgreen", size = 3)+
        xlab(bquote(Log[10]("Vertice")))+
        ylab(bquote(Log[10]("Intensidade")))+
        ggtitle("Log-Log da Distribuição dos Graus") + 
        theme(plot.title = element_text(size = 20, face = "bold"))+
        scale_x_continuous(trans = 'log10') +
        scale_y_continuous(trans = 'log10')

# Desenha graficos em grid
grid.arrange(p7, p8, nrow = 2)

```

* O gráfico da distribuição de graus evidenciou a presença de pelo menos um país, no caso o Brasil, com um grau de ordem superior aos demais países.

* Além de indicar a presença de algum outro país com grau de ordem superior, o gráfico de intensidade na escala logarítmica  indicou uma observação com log de intensidade muito baixo em relação as demais.

### Estatísticas da Rede

* As estatísticas da rede como medidas de centralidade e contagem amplamente utilizadas no universo de grafos foram calculadas para fornecer estimativas como formato, extensão, comunicação, reciprocidade, transitividade e assortatividade.

* Funções do pacote `igraph` foram utilizadas para calcular as estatísticas da rede.

```{r warning=F, error=F, message=F}

# Numero de Graus
vertices <- vcount(g)

# Numero de vertices
arestas <- ecount(g)

# Calcula estatisticas
densidade_arestas <- edge_density(g)

# Calcula trnasitividade
transitividade <- transitivity(g)

# Calcula reciprocidade
reciprocidade <- reciprocity(g, mode="default")

# Calcula Diâmetro
diametro <- diameter(g)

# Calcula grau de Assortatividade
assortatividade <- assortativity.degree(g)

# Declara data frame de medidas de centralidade
centralidade <- tibble(Estatisticas = c("Nº de Vertices",
                                        "Nº de Arestas",
                                        "Densidade das Arestas",
                                        "Transitividade",
                                        "Reciprocidade",
                                        "Diâmetro",
                                        "Assortatividade"),
                       Valores = c(vertices,
                                   arestas,
                                   densidade_arestas,
                                   transitividade,
                                   reciprocidade,
                                   diametro,
                                   assortatividade
                                   )
                       )

# Arredonda resultados
centralidade$Valores <- round(centralidade$Valores, 4)

# Renderiza tabela de resultados
renderDT({
  
  # Tabela de coeficientes
  datatable(centralidade, options = list(dom = 't', pageLength = 7))
  
})

```

* O número total de vértices igual a 23 indica a presença de 23 países na análise.

* O número total de arestas igual a 429 indica a presença de 508 trechos na análise, ou seja, 429 trechos de origens e destinos. Alguns trechos foram repetidos para cada mês.

* O cálculo da densidade das arestas apresentou resultado de 92 %, ou seja, o grafo é bastante conectado porque o número de arestas é bem próximo do máximo de arestas possíveis considerando 24 vértices.

* A cálculo da transitividade ou coeficiente de cluster apresentou o valor de 0.18, o que significa a fraca presença de clusters ou pequena fração de triplas transitivas. Em alguns testes de cluster realizados no rascunho do trabalho que não serão aqui apresentados o fato pode ser confirmado quando algoritmo `fastgreedy.community` só encontrou 1 cluster em torno do Brasil.

* O cálculo da reciprocidade resultou no valor de 0.97, o que indicou que os vértices desta rede direcionada estavam mutualmente ligados. O resultado é razoável já que espera-se que os aviões que vão de uma origem para um destino retornem para esta mesma origem partindo de seus destinos anteriores.

* O diâmetro calculado para a rede foi de 2, ou seja, o maior dos caminhos entre os caminhos mais curtos dos dois vértices mais distantes foi 2. Isto significa que a rede não e muito densa e que é possível atravessar a rede em poucos passos.

* A assortatividade de -0.7 indicou a tendência de vértices com graus maiores se associarem com vértices de graus menores. Tal fato pode ser verificado pela quantidade de associações do Brasil que é o vértice de maior grau na rede com os demais países que seriam os vértices com graus menores.


***

# Modelagem

* O autor indica no capítulo 9 do livro _Statistical Analysis of Network Data_ que os fluxos de redes poderiam ser ajustados por modelos de gravidade. Este modelo linear generalizado com distribuição de Poisson e função de ligação logarítmica é largamente utilizado para modelar o fluxo pessoas, bens ou serviços entre regiões.


## Modelo

* Os modelos de gravidade são largamente utilizados para descrever o nível de agregação da interação entre as pessoas de diferentes populações. Neste caso parece adequado considerar o modelo de gravidade para rede de tráfego aéreo de pessoas entre países.

* Como sugerido por kolackzyk citando a lei de Newton sobre a gravitação universal o volume da população dos vértices e a distância entre os vértices também seriam dados significativo explicar o fluxo de passageiros. As variáveis de número de mortos e casos do Covid-19, bem como indicadores sociais e econômicos também foram inseridas para modelar a quantidade de passageiros.

* As funções $h_{o}(i) \hspace{0.3cm}  h_{d}(j) \hspace{0.3cm} e \hspace{0.3cm} h_{s}(c_{i,j})$ são positivas e representam a origem i, o destino j e o vetor $c_{i,j}$ de K chamado de separação dos atributos, nesta caso a distância em quilômetros. As variáveis de número de mortes e casos, bem como os indicadores socioeconômicos podem ser inseridas no modelo com o pacote `shiny`.

### Especificações

* $\zeta$ = { origens i e destino j } $\in V$ onde I = | $\zeta$ | e J = | $\zeta$ |

* $Z_{i,j} =$ tráfego de pessoas de i $\in \zeta$ até j $\in \zeta$ em um período de tempo.

* $Z_{i,j} \sim Poisson(\lambda)$

* $h_{o}(i)$ = $origem_i$

* $h_{d}(i)$ = $destino_j$

* $h_{s}(c_{i,j})$ = $distância_{i,j}$

* $h_{var}(k) = \prod^{19}_{k = 1} var_{i,j}$

* $E(Z_{i,j}) = h_{0}(i) \hspace{0.3cm}  h_{d}(j) \hspace{0.3cm} h_{s}(c_{i,j}) \hspace{0.3cm} \hspace{0.1cm} h_{var}(k)$

* $log \hspace{0.1cm} E(Z_{i,j}) = log \hspace{0.1cm} h_{0}(i) \hspace{0.3cm} + \hspace{0.3cm} log \hspace{0.1cm} h_{d}(j) \hspace{0.3cm} +  \hspace{0.3cm} log \hspace{0.1cm} h_{s}(c_{i,j}) +  \hspace{0.3cm} log \hspace{0.1cm} \sum^{19}_{k = 1} var_{i,j}$


### Ajuste

* O pacote `shiny` possibilitou a construção de 3 botões para filtrar por grupos de países, período sobre o qual o modelo seria ajustado e covariáveis inseridas no modelo. Os dados foram ajustados utilizando a função `glm` da biblioteca `stats` base R com a família Poisson e a ligação logarítmica. A função `tidy` do pacote `broom` foi utilizada para extrair a tabela de coeficientes e estatísticas do modelo. os gráficos de ajuste foram construídos com o pacote ggplot.

* A variável resposta e as variáveis numéricas foram transformadas para escala de logarítmica na base 10 depois da modelagem para verificar o ajuste e os resíduos. 

```{r warning=F, error=F, message=F}

# Declara modelo interativo
df_modelo <- reactive({
  
    if(input$paisesmodelo == "p1"){
      
      # Somente quando brasil esta em origem ou destino
      df <- df_g %>%
        filter((origem_pais == 'BRASIL' & !destino_pais == 'BRASIL') |
                 (!origem_pais == 'BRASIL' & destino_pais == 'BRASIL')) 
      
    } else if(input$paisesmodelo == "p2"){
      
      # Remove Brasil
      df <- df_g %>%
        filter(!origem_pais == 'BRASIL' & !destino_pais == 'BRASIL')
      
    } else if(input$paisesmodelo == "p3"){
      
      # Todos
      df <- df_g 
      
    }
    
    # Filtra o mês
    df = df %>% filter(mes >= input$mesesmodelo[1] & mes <= input$mesesmodelo[2])
    
    # Retorno
    return(df)
})
    
# Declara modelo interativo
modelo_interativo <- reactive({
  
    # Define formula geral
    formula_geral <- as.formula(paste("passageiros",
                                      paste(input$variavelmodelo,
                                            collapse=" + "), sep=" ~ "))
    
    # Ajusta modelo de Poisson
    gm.g <- glm(formula_geral,
                family=poisson(link = "log"),
                data=df_modelo())
    
    # Retorno da funcao
    return(gm.g)
  
})

# Renderiza tabela de resultados
renderDT({
  
  # Resumo do Modelo
  resultados <- tidy(modelo_interativo()) %>% 
                     mutate_if(is.numeric, round, 6)
    
  # Altera nome das colunas
  colnames(resultados) <- c("Termo", "Coeficiente", "Erro Padrão", "Estatística","P-Valor")
  
  # Tabela de coeficientes
  datatable(resultados,
            options = list(dom = 'tip',
                           pageLength = 5,
                           language = list(url = url_ptbr)),
            caption = htmltools::tags$caption("Tabela do Modelo",
                                              style="color:black; font-weight: bold"))
  
})

# Renderiza Grafico
renderPlot({
  
  # Constroi data frame de valores ajustados vs valores reais
  real_ajustado <- tibble(passageiros = log(df_modelo()$passageiros, 10),
                          ajustados = log(modelo_interativo()$fitted.values, 10))
  
  # Rotulo
  rotulo_aic <- paste0("AIC: ", round(modelo_interativo()$aic))
  
  # Rotulo do Erro
  rotulo_erro <- paste0("Desvio Residual: ", round(deviance(modelo_interativo())))
  
  # Grafico
  p5 <- ggplot(data = real_ajustado,
               aes(x = passageiros,
                   y = ajustados))+
          geom_point(color = "darkgreen",
                     alpha = 0.2, size = 3)+
          geom_abline(slope = 1,
                      intercept = 0,
                      color = "red")+
          xlab(expression(Log[10]("Número de Passageiros")))+
          ylab(expression(Log[10]("Valores Ajustados")))+
          xlim(c(0,6))+
          ylim(c(0,6))+
          ggtitle("Observados x Ajustados") + 
          labs(subtitle = rotulo_aic)+
          theme(plot.title = element_text(size = 15, face = "bold"),
                plot.subtitle = element_text(size = 13, face = "bold", color = "darkgreen")) 
  
  # Residuos
  res <- residuals.glm(modelo_interativo(), type = "response")
  relres <- res / df_modelo()$passageiros
  lrelres <- log(abs(relres),10)
  res.sgn <- (res>=0)
    
  # Constroi data frame de residuos vs valores reais positivos
  real_residuos_positivo <- tibble(passageiros = log(df_modelo()$passageiros, 10)[res.sgn],
                                   residuos = lrelres[res.sgn])
  
  # Constroi data frame de residuos vs valores reais
  real_residuos_negativo <- tibble(passageiros = log(df_modelo()$passageiros, 10)[!res.sgn],
                                   residuos = lrelres[!res.sgn])
  
  # Grafico
  p6 <- ggplot(data = real_residuos_positivo, aes(x = passageiros, y = residuos))+
          geom_point(color = "darkgreen",
                     alpha = 0.2,
                     size = 3)+
          geom_point(data = real_residuos_negativo,
                     aes(x = passageiros,
                         y = residuos),
                     color = "darkgreen",
                     alpha = 0.2,
                     size = 3)+
          geom_hline(yintercept = 0, color = "red")+
          xlab(expression(Log[10]("Número de Passageiros")))+
          ylab(expression(Log[10]("Erro Relativo")))+
          ggtitle("Observados x Erros") + 
          labs(subtitle = rotulo_erro)+
          theme(plot.title = element_text(size = 15, face = "bold"),
                plot.subtitle = element_text(size = 13, face = "bold", color = "darkgreen"))   
  
  # Grid dos graficos de faltantes antes e depois
  grid.arrange(p5, p6, ncol = 2)
  
})


# Seletores do Modelo
fluidRow(
  
    # Coluna de 4
    column(4,
           
      # Seletor de paises
      selectInput("paisesmodelo",
                  "Selecione os países",
                  choices = c("Brasil na Origem ou Destino" = "p1",
                              "Sem Brasil" = "p2",
                              "Todos" = "p3"))
    ),
    
    # Coluna de 4
    column(4,
           
      # Define entrada
      sliderInput("mesesmodelo",
                  "Escolha o Intervalo de meses",
                  min = 1,
                  max = 12,
                  value = c(4,6))
    ),
    
    # Coluna de 4
    column(4,
           
      # Seleciona variavel de comparação
    pickerInput("variavelmodelo",
                "Escolha as variáveis Explicativas",
                choices = c("Distância Km" = "distancia_km",
                            "Total de Casos Origem" = "total_casos_origem",
                            "Total Mortes Origem" = "total_mortes_origem",
                            "Novos Casos Origem" = "novos_casos_origem",
                            "Novas Mortes Origem" = "novas_mortes_origem",
                            "Renda per Capta Origem" = "pib_origem",
                            "Indice de Desenvolvimento Humano Origem" = "idh_origem",
                            "População Origem" = "populacao_origem",
                            "Expectativa de vida Origem" = "expectativa_vida_origem",
                            "Total de Casos Destino" = "total_casos_destino",
                            "Total Mortes Destino" = "total_mortes_destino",
                            "Novos Casos Destino" = "novos_casos_destino",
                            "Novas Mortes Destino" = "novas_mortes_destino",
                            "Renda per Capta Destino" = "pib_destino",
                            "Indica de Desenvolvimento Humano Destino" = "idh_destino",
                            "População Destino" = "populacao_destino",
                            "Expectativa de vida Destino" = "expectativa_vida_destino"),
                selected = c("Distância Km" = "distancia_km",
                            "Total de Casos Origem" = "total_casos_origem",
                            "Total Mortes Origem" = "total_mortes_origem",
                            "Novos Casos Origem" = "novos_casos_origem",
                            "Novas Mortes Origem" = "novas_mortes_origem",
                            "Renda per Capta Origem" = "pib_origem",
                            "Indice de Desenvolvimento Humano Origem" = "idh_origem",
                            "População Origem" = "populacao_origem",
                            "Expectativa de vida Origem" = "expectativa_vida_origem",
                            "Total de Casos Destino" = "total_casos_destino",
                            "Total Mortes Destino" = "total_mortes_destino",
                            "Novos Casos Destino" = "novos_casos_destino",
                            "Novas Mortes Destino" = "novas_mortes_destino",
                            "Renda per Capta Destino" = "pib_destino",
                            "Indica de Desenvolvimento Humano Destino" = "idh_destino",
                            "População Destino" = "populacao_destino",
                            "Expectativa de vida Destino" = "expectativa_vida_destino"),
                options = list('actions-box' = TRUE),
                multiple = TRUE)
    )
)


```

* Considerando o Brasil na origem e no destino das rotas, em todos os trimestres, todas as covariáveis tiveram significância estatística com excessão de uma ou outra em cada trimestre. Porem o modelo só começou a ajustar bem os dados do segundo ao quarto trimestre onde as variáveis do Covid-19 conseguiram explicar melhor a flutuação no número de passageiros.

* Considerando países sem Brasil na origem ou no destino, o primeiro trimestre não apresentou significância estatística para as variáveis `total_casos_origem` e `total_casos_destino`. Os outros trimestres também apresentaram variáveis não significativas o que pode indicar a ausência de dados devido ao fato de que as rotas de companhias aéreas brasileiras fora do Brasil são poucas. Contudo do segundo ao quarto trimestres o modelo ajustou bem os dados nesse cenário.

## Conclusões

### Modelagem

* Foi possível concluir que:
  + O modelo de gravidade ajustou bem a flutuação no número de passageiros quando a pandemia tomou proporções globais.
  + As contagem de mortos e casos do Covid-19 bem como os indicadores socioeconômicos adicionaram explicação sobre o número de passageiros reduzindo o erro de predição.
  

### Próximos Passos

* Levando em consideração o fato de que o tráfego aéreo das companhias brasileiras junto com o das companhias internacionais constitui a rede de transporte aéreos mundial. É razoável inserir essas informações de outras companhias aéreas em futuros modelos para melhores ajustes.

* Também é possível considerar e avaliar em ajuste futuros se uma escala mais granular do tempo como semanas ou dias não levaria a um ajuste mais preciso do modelo ou inseriria mais ruido.

* Finalmente pode-se concluir que informações que não foram achadas de forma estruturada como datas de fechamentos e aberturas dos espaços aéreos de cada país em função da intensificação ou diminuição da pandemia talvez forneçam explicações melhores para a variação no número de passageiros do que o número de casos e mortes.

***

# Referências

* As referências de maior relevância foram classificadas por categorias. Diversas fontes para detalhes pontuais da análise como uso dos pacotes `shiny` e `Rmarkdown` não foram citadas devido ao grande número mas foram fundamentais para a produção deste relatório.

## Bibliográficas

* Eric D. Kolaczyk. 2009. Statistical Analysis of Network Data: Methods and Models (1st. ed.). Springer Publishing Company, Incorporated.

* Slides e Video aulas do curso Introdução a Grafos Aleatórios.

## Dados

* Transporte Aéreo: [ANAC](https://www.anac.gov.br/assuntos/dados-e-estatisticas/dados-estatisticos/dados-estatisticos)
* COVID 19: [ourworldindata](https://ourworldindata.org/coronavirus#which-countries-are-making-progress-against-the-pandemic)
* Coordenadas Geográficas: [developers.google](https://developers.google.com/public-data/docs/canonical/countries_csv)
* Código dos Países: [sport-histoire](https://www.sport-histoire.fr/pt/Geografia/Codigos_ISO_Paises.php)

## R

* Pacotes e bibliotecas utilizadas:
  + __tidyverse__
  + __igraph__
  + __lubridate__
  + __DT__
  + __naniar__
  + __shiny__
  + __broom__
  + __geosphere__
  + __gridExtra__
  + __shinyWidgets__
  + __visNetwork__

## Rede Mundial de Computadores
  
  * Transmissão por Aviões: [npr](https://www.npr.org/sections/goatsandsoda/2020/08/21/904689295/coronavirus-faq-so-do-lots-of-people-get-covid-19-from-flying)
  * Recuperação da Companhias Aéreas: [mckinsey](https://www.mckinsey.com/industries/travel-logistics-and-transport-infrastructure/our-insights/will-airline-hubs-recover-from-covid-19)
  * Adaptação das Companhias Aéreas [insights](https://insights.som.yale.edu/insights/how-is-the-airline-industry-adapting-to-covid#gref)
  * Icones da bandeiras: [flaticon](https://www.flaticon.com/)











